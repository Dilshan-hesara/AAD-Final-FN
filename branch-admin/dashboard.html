<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--  <meta charset="UTF-8">-->
<!--  <title>Branch Dashboard</title>-->
<!--  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">-->
<!--  <link rel="stylesheet" href="../css/styles.css">-->
<!--  <script src="../js/auth.js" defer></script>-->
<!--</head>-->
<!--<body>-->
<!--<div id="sidebar-placeholder"></div>-->

<!--<div class="content">-->
<!--  <div class="d-flex justify-content-between align-items-center mb-3">-->
<!--    <div>-->
<!--      <h1 class="mb-0">Branch Dashboard</h1>-->
<!--      <p id="current-date-time" class="text-muted"></p>-->
<!--    </div>-->
<!--    <a href="../book-appointment.html" class="btn btn-lg btn-success" target="_blank">-->
<!--      <i class="bi bi-globe"></i> Book Online Appointment-->
<!--    </a>-->
<!--  </div>-->
<!--  <hr>-->

<!--  <h4 class="mb-3">Overview</h4>-->
<!--  <div class="row">-->
<!--    <div class="col-lg-3 col-md-6 mb-4">-->
<!--      <div class="card bg-warning text-dark h-100"><div class="card-body text-center"><i class="bi bi-heart-pulse-fill fs-1"></i><h5 class="mt-2">Active Doctors</h5><h2 id="doctor-count" class="display-5">...</h2></div></div>-->
<!--    </div>-->
<!--    <div class="col-lg-3 col-md-6 mb-4">-->
<!--      <div class="card bg-info text-white h-100"><div class="card-body text-center"><i class="bi bi-person-workspace fs-1"></i><h5 class="mt-2">Receptionists</h5><h2 id="receptionist-count" class="display-5">...</h2></div></div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div class="row">-->
<!--    <div class="col-lg-3 col-md-6 mb-4">-->
<!--      <div class="card bg-success text-white h-100">-->
<!--        <div class="card-body text-center"><i class="bi bi-cash-coin fs-1"></i>-->
<!--          <h5 class="mt-2">Today's Earnings</h5>-->
<!--          <h2 id="todays-earnings" class="display-5">...</h2>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->


<!--    <div class="col-lg-4">-->
<!--      <div class="card shadow-sm mb-4">-->
<!--        <div class="card-header"><i class="bi bi-pie-chart-fill"></i> Today's Appointment Status</div>-->
<!--        <div class="card-body">-->
<!--          <canvas id="appointmentStatusChart"></canvas>-->
<!--        </div>-->
<!--      </div>-->
<!--      <div class="card shadow-sm">-->
<!--        <div class="card-header"><i class="bi bi-lightning-fill"></i> Quick Actions</div>-->
<!--        <div class="card-body d-grid gap-2">-->
<!--          <a href="book-appointment.html" class="btn btn-outline-primary"><i class="bi bi-calendar-plus"></i> Book for a Patient</a>-->
<!--          <a href="patient.html" class="btn btn-outline-secondary"><i class="bi bi-person-plus"></i> Add New Patient</a>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <h4 class="mb-3 mt-4">Today's Appointments</h4>-->
<!--  <div class="row">-->
<!--    <div class="col-lg-3 col-md-6 mb-4">-->
<!--      <div class="card bg-primary text-white h-100"><div class="card-body text-center"><i class="bi bi-calendar-plus-fill fs-1"></i><h5 class="mt-2">Confirmed Today</h5><h2 id="confirmed-count" class="display-5">...</h2></div></div>-->
<!--    </div>-->
<!--    <div class="col-lg-3 col-md-6 mb-4">-->
<!--      <div class="card bg-success text-white h-100"><div class="card-body text-center"><i class="bi bi-calendar-check-fill fs-1"></i><h5 class="mt-2">Completed Today</h5><h2 id="completed-count" class="display-5">...</h2></div></div>-->
<!--    </div>-->
<!--    <div class="col-lg-3 col-md-6 mb-4">-->
<!--      <div class="card bg-danger text-white h-100"><div class="card-body text-center"><i class="bi bi-calendar-x-fill fs-1"></i><h5 class="mt-2">Cancelled Today</h5><h2 id="cancelled-count" class="display-5">...</h2></div></div>-->
<!--    </div>-->
<!--  </div>-->

<!--  <div class="card mt-4 shadow-sm">-->
<!--    <div class="card-header"><i class="bi bi-cloud-check-fill"></i> Today's Online Bookings</div>-->
<!--    <div class="card-body">-->
<!--      <table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Patient</th><th>Doctor</th><th>Time</th><th>Status</th></tr></thead><tbody id="online-bookings-table"></tbody></table>-->
<!--    </div>-->
<!--  </div>-->
<!--</div>-->

<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->
<!--<script src="../js/layout-loader.js"></script>-->
<!--<script>-->
<!--  document.addEventListener('DOMContentLoaded', function() {-->
<!--    // Clock-->
<!--    function updateClock() {-->
<!--      const now = new Date();-->
<!--      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };-->
<!--      document.getElementById('current-date-time').textContent = now.toLocaleDateString('en-US', options);-->
<!--    }-->
<!--    updateClock();-->
<!--    setInterval(updateClock, 1000);-->

<!--    // Online Bookings-->
<!--    const token = localStorage.getItem('authToken');-->
<!--    fetch('http://localhost:8080/api/appointments/online-bookings/today', { headers: { 'Authorization': 'Bearer ' + token } })-->
<!--            .then(res => res.json())-->
<!--            .then(appointments => {-->
<!--              const tbody = document.getElementById('online-bookings-table');-->
<!--              tbody.innerHTML = '';-->
<!--              if (appointments.length > 0) {-->
<!--                appointments.forEach(app => {-->
<!--                  const time = new Date(app.appointmentDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });-->
<!--                  tbody.innerHTML += `<tr><td>${app.id}</td><td>${app.patientName}</td><td>${app.doctorName}</td><td>${time}</td><td><span class="badge bg-primary">${app.status}</span></td></tr>`;-->
<!--                });-->
<!--              } else {-->
<!--                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No online bookings for today.</td></tr>';-->
<!--              }-->
<!--            });-->
<!--  });-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Branch Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="../css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../js/auth.js" defer></script>
</head>
<body>
<div id="sidebar-placeholder"></div>

<div class="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="mb-0">Branch Dashboard</h1>
      <p id="current-date-time" class="text-muted"></p>
    </div>
  </div>
  <hr>

  <!-- Top Row Statistics -->
  <div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card bg-success text-white h-100"><div class="card-body"><h5 class="card-title">Today's Earnings</h5><h2 id="todays-earnings" class="display-5">...</h2></div></div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card bg-warning text-dark h-100"><div class="card-body"><h5 class="card-title">Active Doctors</h5><h2 id="doctor-count" class="display-5">...</h2></div></div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card bg-info text-white h-100"><div class="card-body"><h5 class="card-title">Receptionists</h5><h2 id="receptionist-count" class="display-5">...</h2></div></div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-success h-100"><div class="card-body text-success"><h5 class="card-title">Completed Today</h5><h2 id="completed-count" class="display-5">...</h2></div></div>
    </div>
  </div>

  <!-- Today's Appointment Summary -->
  <h4 class="mt-4 mb-3">Today's Appointments</h4>
  <div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-primary h-100"><div class="card-body text-primary"><h5 class="card-title">Online Bookings</h5><h2 id="online-count" class="display-5">...</h2></div></div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card border-secondary h-100"><div class="card-body text-secondary"><h5 class="card-title">Walk-in / Manual</h5><h2 id="walkin-count" class="display-5">...</h2></div></div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card bg-primary text-white h-100"><div class="card-body"><h5 class="card-title">Confirmed Today</h5><h2 id="confirmed-count" class="display-5">...</h2></div></div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
      <div class="card bg-danger text-white h-100"><div class="card-body"><h5 class="card-title">Cancelled Today</h5><h2 id="cancelled-count" class="display-5">...</h2></div></div>
    </div>
  </div>

<!--  <div class="card shadow-sm">-->
<!--    <div class="card-header"><i class="bi bi-lightning-fill"></i> Quick Actions</div>-->
<!--    <div class="card-body d-grid gap-2">-->
<!--      <a href="book-appointment.html" class="btn btn-outline-primary"><i class="bi bi-calendar-plus"></i> Book for a Patient</a>-->
<!--      <a href="patient.html" class="btn btn-outline-secondary"><i class="bi bi-person-plus"></i> Add New Patient</a>-->
<!--    </div>-->
<!--  </div>-->

  <!-- Chart and Doctors on Duty -->
  <div class="row mt-4">
    <div class="col-lg-8">
      <div class="card shadow-sm h-100">
        <div class="card-header">Doctors on Duty</div>
        <ul id="doctors-on-duty-list" class="list-group list-group-flush">
        </ul>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-header">Appointment Status Breakdown</div>
        <div class="card-body"><canvas id="appointmentStatusChart"></canvas></div>
      </div>
    </div>
  </div>


  <div class="card mt-4 shadow-sm">
    <div class="card-header"><i class="bi bi-cloud-check-fill"></i> Today's Online Bookings</div>
    <div class="card-body">
      <table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Patient</th><th>Doctor</th><th>Time</th><th>Status</th></tr></thead><tbody id="online-bookings-table"></tbody></table>
    </div>
  </div>
</div>


<script src="../js/layout-loader.js"></script>
<script>
  let myChart; // Variable to hold the chart instance

  // Function to update the clock
  function updateClock() { document.getElementById('current-date-time').textContent = new Date().toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'medium' }); }
  updateClock(); setInterval(updateClock, 1000);

  // This function is called from layout-loader.js to populate the page
  function loadDashboardData(data) {
    document.getElementById('todays-earnings').textContent = `Rs. ${data.todaysEarnings.toFixed(2)}`;
    document.getElementById('doctor-count').textContent = data.doctorCount;
    document.getElementById('receptionist-count').textContent = data.receptionistCount;
    document.getElementById('online-count').textContent = data.onlineAppointments;
    document.getElementById('walkin-count').textContent = data.walkInAppointments;
    document.getElementById('completed-count').textContent = data.completedCount;
    document.getElementById('confirmed-count').textContent = data.confirmedCount;
    document.getElementById('cancelled-count').textContent = data.cancelledCount;
    renderAppointmentChart(data);
  }

  // This function is called from layout-loader.js to populate the doctors list
  // function loadDoctorsOnDuty() {
  //   const token = localStorage.getItem('authToken');
  //   fetch('http://localhost:8080/api/doctors', { headers: { 'Authorization': 'Bearer ' + token } })
  //           .then(res => res.json())
  //           .then(doctors => {
  //             const list = document.getElementById('doctors-on-duty-list');
  //             list.innerHTML = '';
  //             if(doctors.length > 0) {
  //               doctors.forEach(doc => {
  //                 list.innerHTML += `<li class="list-group-item">${doc.fullName} (${doc.specialization})</li>`;
  //               });
  //             } else {
  //               list.innerHTML = '<li class="list-group-item">No active doctors found.</li>';
  //             }
  //           });
  // }


  function loadDoctorsOnDuty() {
    const token = localStorage.getItem('authToken');

    // --- CORRECTED: Call the new, simpler API endpoint ---
    fetch('http://localhost:8080/api/doctors/active-list', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => {
              if (!res.ok) { throw new Error("Failed to load doctors list"); }
              return res.json();
            })
            .then(doctors => {
              const list = document.getElementById('doctors-on-duty-list');
              list.innerHTML = '';
              if(doctors.length > 0) {
                doctors.forEach(doc => {
                  list.innerHTML += `<li class="list-group-item">${doc.fullName} (${doc.specialization})</li>`;
                });
              } else {
                list.innerHTML = '<li class="list-group-item">No active doctors found.</li>';
              }
            })
            .catch(error => {
              console.error("Error loading doctors on duty:", error);
              const list = document.getElementById('doctors-on-duty-list');
              list.innerHTML = '<li class="list-group-item text-danger">Could not load doctor list.</li>';
            });
  }

  function renderAppointmentChart(data) {
    const ctx = document.getElementById('appointmentStatusChart');
    if (!ctx) return;

    // CRITICAL FIX: Destroy the old chart before creating a new one
    if (myChart) {
      myChart.destroy();
    }

    myChart = new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Confirmed', 'Completed', 'Cancelled'],
        datasets: [{
          data: [data.confirmedCount, data.completedCount, data.cancelledCount],
          backgroundColor: ['#0d6efd', '#198754', '#dc3545']
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }


  // Online Bookings
  const token = localStorage.getItem('authToken');
  fetch('http://localhost:8080/api/appointments/online-bookings/today', { headers: { 'Authorization': 'Bearer ' + token } })
          .then(res => res.json())
          .then(appointments => {
            const tbody = document.getElementById('online-bookings-table');
            tbody.innerHTML = '';
            if (appointments.length > 0) {
              appointments.forEach(app => {
                const time = new Date(app.appointmentDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                tbody.innerHTML += `<tr><td>${app.id}</td><td>${app.patientName}</td><td>${app.doctorName}</td><td>${time}</td><td><span class="badge bg-primary">${app.status}</span></td></tr>`;
              });
            } else {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center">No online bookings for today.</td></tr>';
            }
          });
</script>
</body>
</html>