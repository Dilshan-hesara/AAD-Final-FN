<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book New Appointment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/auth.js" defer></script>
</head>
<body>
<div id="sidebar-placeholder"></div>
<div class="content">
    <h1>Book New Appointment</h1>
    <hr>
    <div class="card">
        <div class="card-body">
            <form id="book-appointment-form">
                <div class="mb-3">
                    <label class="form-label">Search & Select Patient</label>
                    <select id="patient-select" class="form-select" required></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Search & Select Doctor</label>
                    <select id="doctor-select" class="form-select" required></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Appointment Date & Time</label>
                    <input type="datetime-local" id="appointmentDate" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success">Book Appointment</button>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPT LIBRARIES (Load these only once) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="../js/layout-loader.js"></script>

<!-- YOUR CUSTOM SCRIPT (Only one block) -->
<script>
    $(document).ready(function() {
        const token = localStorage.getItem('authToken');

        // Initialize Select2 for Patients with AJAX search
        $('#patient-select').select2({
            placeholder: 'Type to search for a patient...',
            ajax: {
                url: 'http://localhost:8080/api/patients/search',
                dataType: 'json',
                delay: 250,
                headers: { 'Authorization': 'Bearer ' + token },
                data: function (params) {
                    return { name: params.term, page: params.page || 0, size: 10 };
                },
                processResults: function (data, params) {
                    params.page = params.page || 0;
                    return {
                        results: data.content.map(p => ({ id: p.id, text: p.fullName })),
                        pagination: { more: !data.last }
                    };
                },
                cache: true
            }
        });

        // Initialize Select2 for Doctors with AJAX search
        $('#doctor-select').select2({
            placeholder: 'Type to search for a doctor...',
            ajax: {
                url: 'http://localhost:8080/api/doctors/search',
                dataType: 'json',
                delay: 250,
                headers: { 'Authorization': 'Bearer ' + token },
                data: function (params) {
                    return { name: params.term, page: params.page || 0, size: 10 };
                },
                processResults: function (data, params) {
                    params.page = params.page || 0;
                    return {
                        results: data.content.map(d => ({ id: d.id, text: `${d.fullName} (${d.specialization})` })),
                        pagination: { more: !data.last }
                    };
                },
                cache: true
            }
        });

        // Handle the form submission when the button is clicked
        $('#book-appointment-form').on('submit', function(e) {
            e.preventDefault();

            const appointmentData = {
                patientId: $('#patient-select').val(),
                doctorId: $('#doctor-select').val(),
                appointmentDate: $('#appointmentDate').val()
            };

            if (!appointmentData.patientId || !appointmentData.doctorId || !appointmentData.appointmentDate) {
                alert('Please select a patient, doctor, and date.');
                return;
            }

            $.ajax({
                url: 'http://localhost:8080/api/appointments',
                type: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                data: JSON.stringify(appointmentData),
                success: function() {
                    alert('Appointment booked successfully!');
                    window.location.href = 'appointments.html';
                },
                error: function() {
                    alert('Error booking appointment. Please try again.');
                }
            });
        });
    });
</script>
</body>
</html>