
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book New Appointment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="../js/auth.js" defer></script>

    <style>
        :root {
            --primary-light: #f4f7fc;
            --text-dark: #1a202c;
            --text-muted-light: #6c757d;
            --border-color: #e9ecef;
            --primary-blue: #0d6efd;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-light);
        }

        .sidebar {
            width: 280px; position: fixed; left: 0; top: 0; height: 100vh; z-index: 1000;
            background-color: #ffffff; border-right: 1px solid #e9ecef; display: flex;
            flex-direction: column; padding: 1.5rem 1rem; transition: width 0.3s ease;
        }
        .content { margin-left: 280px; padding: 2.5rem; width: calc(100% - 280px); }

        .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.05); }
        .modal-content { border: none; border-radius: 0.75rem; }
        h1 { font-weight: 700; }
        .form-label { font-weight: 500; color: var(--text-muted-light); }
        .form-control, .form-select { border-radius: 0.5rem; border-color: var(--border-color); }
        .form-control:focus, .form-select:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-control[readonly] { background-color: #e9ecef; }

        .select2-container--default .select2-selection--single { height: calc(1.5em + 0.75rem + 2px); border: 1px solid var(--border-color); border-radius: 0.5rem; }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: calc(1.5em + 0.75rem); padding-left: 0.75rem; color: #495057; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: calc(1.5em + 0.75rem); }
        .select2-container--default.select2-container--open .select2-selection--single { border-color: var(--primary-blue); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .select2-dropdown { border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.05); }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable { background-color: var(--primary-blue); }
        .select2-search--dropdown .select2-search__field { border-radius: 0.375rem; border-color: var(--border-color); }
        .select2-search--dropdown .select2-search__field:focus { border-color: var(--primary-blue); }

        #sidebar-profile-pic { border: 3px solid #dee2e6; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        #sidebar-branch-name { font-weight: 600; color: #212529; margin-top: 0.5rem; margin-bottom: 0.25rem; }
        #sidebar-admin-name { color: #6c757d; font-size: 0.85rem; }
        .sidebar a, .sidebar .nav-link { display: flex; align-items: center; padding: 0.8rem 1rem; margin: 0.25rem 0; color: #495057; text-decoration: none; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s ease, color 0.2s ease; }
        .sidebar a i, .sidebar .nav-link i { font-size: 1.2rem; width: 30px; margin-right: 0.5rem; }
        .sidebar a:hover, .sidebar .nav-link:hover { background-color: rgba(13, 110, 253, 0.1); color: #0d6efd; }
        .sidebar a.active { background-color: #0d6efd; color: #fff; font-weight: 500; box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2); }
        .sidebar hr { border-color: #e9ecef; }
        .sidebar .dropdown-menu { border-radius: 0.5rem; border: 1px solid #dee2e6; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        #notification-badge { font-size: 0.65em !important; }
        .sidebar-footer { margin-top: auto; }
    </style>
</head>
<body>
<div id="sidebar-placeholder"></div>

<div class="content">
    <h1 class="mb-2">Book New Appointment</h1>
    <p class="text-muted mb-4">Fill in the details below to schedule a new appointment for a patient.</p>
    <div class="card">
        <div class="card-body p-4">
            <form id="book-appointment-form">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Search & Select Patient</label>
                        <select id="patient-select" class="form-select" required></select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Search & Select Doctor</label>
                        <select id="doctor-select" class="form-select" required></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Appointment Date & Time</label>
                        <input type="datetime-local" id="appointmentDate" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="appointmentFee" class="form-label">Appointment Fee (Rs.)</label>
                        <input type="text" id="appointmentFee" class="form-control" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="reason" class="form-label">Reason for Visit (Optional)</label>
                    <textarea id="reason" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success"><i class="bi bi-calendar-check-fill me-1"></i> Book Appointment</button>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="billModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Appointment Summary & Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bill-content"></div>
            <div class="modal-footer">
                <button id="print-btn" type="button" class="btn btn-primary"><i class="bi bi-printer me-1"></i> Print / Save</button>
                <button id="download-pdf-btn" type="button" class="btn btn-secondary"><i class="bi bi-file-earmark-arrow-down-fill me-1"></i> Download PDF</button>
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="../js/layout-loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
    $(document).ready(function() {
        const token = localStorage.getItem('authToken');
        let defaultFee = 0;

        $('#patient-select').select2({
            placeholder: 'Type to search for a patient...',
            ajax: {
                url: 'http://localhost:8080/api/patients/search',
                dataType: 'json',
                delay: 250,
                headers: { 'Authorization': 'Bearer ' + token },
                data: params => ({ name: params.term, page: params.page || 0 }),
                processResults: data => ({
                    results: data.content.map(p => ({ id: p.id, text: `${p.fullName} (${p.contactNumber})` }))
                })
            }
        });

        $('#doctor-select').select2({
            placeholder: 'Type to search for a doctor...',
            ajax: {
                url: 'http://localhost:8080/api/doctors/search',
                dataType: 'json',
                delay: 250,
                headers: { 'Authorization': 'Bearer ' + token },
                data: params => ({ name: params.term, page: params.page || 0 }),
                processResults: data => ({
                    results: data.content.map(d => ({ id: d.id, text: `${d.fullName} (${d.specialization})` }))
                })
            }
        });

        $.ajax({
            url: 'http://localhost:8080/api/settings/appointment-fee',
            type: 'GET',
            headers: { 'Authorization': 'Bearer ' + token },
            success: data => {
                defaultFee = Number(data.fee || 0);
                $('#appointmentFee').val(defaultFee.toFixed(2));
            }
        });

        function buildBillHTML({patientText, doctorText, dateTime, fee, reason, billNo}) {
            return `
          <div id="print-area" style="font-family: Arial, sans-serif; color: #000;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
              <div>
                <h3 style="margin:0;">Hospital Management System</h3>
                <div style="font-size:12px;color:#666;">Appointment Summary & Bill</div>
              </div>
              <div style="text-align:right;">
                <div><strong>Bill No:</strong> ${billNo}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleDateString()}</div>
              </div>
            </div>
            <hr>
            <div style="margin:16px 0; font-size: 14px;">
              <div style="margin-bottom: 8px;"><strong>Patient:</strong> ${patientText || '-'}</div>
              <div style="margin-bottom: 8px;"><strong>Doctor:</strong> ${doctorText || '-'}</div>
              <div style="margin-bottom: 8px;"><strong>Appointment:</strong> ${new Date(dateTime).toLocaleString() || '-'}</div>
              <div><strong>Reason:</strong> ${reason ? reason.replace(/\n/g,'<br>') : '-'}</div>
            </div>
            <hr>
            <div style="display:flex; justify-content:flex-end; margin-top: 16px;">
              <table style="min-width:320px; border-collapse: collapse;">
                <tr style="border-bottom: 1px solid #ccc;">
                  <td style="padding:8px;">Appointment Fee</td>
                  <td style="padding:8px; text-align:right;">Rs. ${Number(fee||0).toFixed(2)}</td>
                </tr>
                <tr style="font-weight: bold; font-size: 1.1em;">
                  <td style="padding:10px 8px;">Total</td>
                  <td style="padding:10px 8px; text-align:right;">Rs. ${Number(fee||0).toFixed(2)}</td>
                </tr>
              </table>
            </div>
            <div style="margin-top:24px; font-size:12px; color:#666; text-align:center;">
              * This is a system generated bill for your appointment booking.
            </div>
          </div>
        `;
        }

        function openPrintPreview(html) {
            const w = window.open('', '_blank');
            w.document.open();
            w.document.write(`
          <html><head><title>Appointment Bill</title>
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <style>@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }</style>
          </head><body>${html}<script>window.onload = function(){ window.print(); };<\/script></body></html>`);
            w.document.close();
        }

        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const billNode = document.querySelector('#bill-content #print-area');
            if (!billNode) return;
            const canvas = await html2canvas(billNode, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = pageWidth - 40;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 20;
            pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
            heightLeft -= (pageHeight - 40);
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight + 20;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 20, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            pdf.save(`appointment-bill-${Date.now()}.pdf`);
        }

        $('#book-appointment-form').on('submit', function(e) {
            e.preventDefault();
            const patientId = $('#patient-select').val();
            const doctorId  = $('#doctor-select').val();
            if (!patientId || !doctorId) {
                alert('Please select both a patient and a doctor.');
                return;
            }
            const patientText = $('#patient-select').find(':selected').text();
            const doctorText  = $('#doctor-select').find(':selected').text();
            const appointmentData = {
                patientId,
                doctorId,
                appointmentDate: $('#appointmentDate').val(),
                reason: $('#reason').val()
            };
            $.ajax({
                url: 'http://localhost:8080/api/appointments/by-staff',
                type: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                data: JSON.stringify(appointmentData),
                success: function(savedAppointment) {
                    const billNo = 'AP-' + savedAppointment.id;
                    const fee = Number($('#appointmentFee').val() || defaultFee || 0);
                    const html = buildBillHTML({
                        patientText, doctorText,
                        dateTime: $('#appointmentDate').val(),
                        fee, reason: $('#reason').val(), billNo
                    });
                    $('#bill-content').html(html);
                    const modal = new bootstrap.Modal(document.getElementById('billModal'));
                    modal.show();
                    $('#print-btn').off('click').on('click', () => openPrintPreview(html));
                    $('#download-pdf-btn').off('click').on('click', () => downloadPDF());
                    $('#billModal').off('hidden.bs.modal').on('hidden.bs.modal', () => {
                        window.location.href = 'appointments.html';
                    });
                },
                error: function() {
                    alert('Error booking appointment.');
                }
            });
        });
    });
</script>
</body>
</html>









