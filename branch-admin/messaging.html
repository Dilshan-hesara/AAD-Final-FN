<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Internal Messaging</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="../js/auth.js" defer></script>

  <style>
    :root {
      --primary-light: #f4f7fc;
      --text-dark: #1a202c;
      --text-muted-light: #6c757d;
      --border-color: #e9ecef;
      --primary-blue: #0d6efd;
      --sender-bg: linear-gradient(135deg, #0d6efd 0%, #0558c_f 100%);
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--primary-light);
    }

    .content { padding: 2.5rem; }
    .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 25px rgba(0, 0, 0, 0.05); }
    .modal-content { border: none; border-radius: 0.75rem; }
    h1 { font-weight: 700; }

    .chat-container { display: flex; height: calc(100vh - 230px); min-height: 500px; }

    .contact-list { width: 35%; border-right: 1px solid var(--border-color); overflow-y: auto; padding: 0.5rem 0; }
    .contact-list .list-group-item { border: none; border-radius: 0; padding: 1rem 1.5rem; }
    .contact-list .list-group-item.active { background-color: var(--primary-light); border-right: 3px solid var(--primary-blue); color: var(--text-dark); }
    .contact-list .list-group-item:not(.active):hover { background-color: #f8f9fa; }
    .contact-name { font-weight: 500; }
    .contact-role { font-size: 0.8rem; color: var(--text-muted-light); }
    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background-color: var(--primary-blue);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 1rem;
      margin-right: 1rem;
    }

    .chat-window { width: 65%; display: flex; flex-direction: column; }
    .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); background-color: #fff; }
    .chat-header h5 { margin: 0; font-weight: 600; }

    .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; background-color: var(--primary-light); }
    .message { margin-bottom: 20px; display: flex; flex-direction: column; }
    .message-content { padding: 10px 15px; border-radius: 18px; max-width: 70%; box-shadow: 0 1px 2px rgba(0,0,0,0.08); position: relative; }

    .receiver { align-items: flex-start; }
    .receiver .message-content { background-color: #ffffff; border: 1px solid #e9ecef; border-top-left-radius: 4px; }

    .sender { align-items: flex-end; }
    .sender .message-content { background: var(--sender-bg); color: white; border-bottom-right-radius: 4px; }

    .sender-name { font-weight: 500; font-size: 0.8rem; color: var(--text-muted-light); margin-bottom: 5px; }

    .message-form-container { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background: #fff; }
    #message-input { border-radius: 20px; border: 1px solid var(--border-color); background-color: #f8f9fa; padding: 0.5rem 1rem; }
    #message-input:focus { background-color: #fff; box-shadow: none; border-color: var(--primary-blue); }
    .send-btn { background: var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    .send-btn i { color: white; }



    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      padding: 1.5rem 1rem;
      background-color: #ffffff;
      border-right: 1px solid #e9ecef;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
    }

    #sidebar-profile-pic {
      border: 3px solid #dee2e6;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    #sidebar-branch-name {
      font-weight: 600;
      color: #212529;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    #sidebar-admin-name {
      color: #6c757d;
      font-size: 0.85rem;
    }

    .sidebar a, .sidebar .nav-link {
      display: flex;
      align-items: center;
      padding: 0.8rem 1rem;
      margin: 0.25rem 0;
      color: #495057;
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    .sidebar a i, .sidebar .nav-link i {
      font-size: 1.2rem;
      width: 30px;
      margin-right: 0.5rem;
    }


    .sidebar a:hover, .sidebar .nav-link:hover {
      background-color: rgba(13, 110, 253, 0.1);
      color: #0d6efd;
    }

    .sidebar a.active {
      background-color: #0d6efd;
      color: #fff;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(13, 110, 253, 0.2);
    }


    .sidebar hr {
      border-color: #e9ecef;
    }

    .sidebar .dropdown-menu {
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    #notification-badge {
      font-size: 0.65em !important;
    }

    .sidebar-footer {
      margin-top: auto;
    }



    .sidebar {
      width: 280px;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 1000;
    }


    .content {
      margin-left: 280px;
      padding: 2.5rem;
      width: calc(100% - 280px);
    }
  </style>
</head>
<body>
<div id="sidebar-placeholder"></div>
<div class="content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Internal Messaging</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeModal"><i class="bi bi-pencil-square me-1"></i> New Message</button>
  </div>

  <div class="card">
    <div class="card-body p-0">
      <div class="chat-container">
        <div id="contacts-list" class="contact-list list-group list-group-flush">
          <div class="p-3 text-center text-muted">Loading contacts...</div>
        </div>
        <div class="chat-window">
          <div class="chat-header"><h5 id="chat-header">Select a contact to start</h5></div>
          <div id="chat-messages" class="chat-messages">
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
              <i class="bi bi-chat-dots" style="font-size: 4rem;"></i>
              <p class="mt-3">Your conversation will appear here.</p>
            </div>
          </div>
          <div class="message-form-container">
            <form id="message-form" class="d-flex align-items-center">
              <input type="text" id="message-input" class="form-control" placeholder="Type a message..." required disabled>
              <button type="submit" class="btn send-btn ms-2 flex-shrink-0"><i class="bi bi-send-fill"></i></button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="composeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="compose-form">
        <div class="modal-header"><h5 class="modal-title">Compose New Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">To:</label><select id="recipient-select" class="form-select" required></select></div>
          <div class="mb-3"><label class="form-label">Message:</label><textarea id="compose-message-text" class="form-control" rows="4" required></textarea></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Send Message</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/layout-loader.js"></script>
<script>
  const token = localStorage.getItem('authToken');
  let myProfile = {};
  let activeConversation = {};
  const composeModal = new bootstrap.Modal(document.getElementById('composeModal'));

  function loadContacts() {
    fetch('http://localhost:8080/api/staff/my-profile', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(profile => {
      myProfile = profile;
      fetch('http://localhost:8080/api/messages/contacts', { headers: { 'Authorization': 'Bearer ' + token } })
              .then(res => res.json()).then(contacts => {
        const list = document.getElementById('contacts-list');
        const recipientSelect = document.getElementById('recipient-select');
        list.innerHTML = '';
        recipientSelect.innerHTML = '<option value="">-- Select a Recipient --</option>';

        const createContactElement = (contactData, displayName, displayRole) => {
          const firstLetter = displayName.charAt(0).toUpperCase();
          return `
                        <a href="#" class="list-group-item list-group-item-action" data-contact='${JSON.stringify(contactData)}' onclick='loadConversation(this)'>
                            <div class="d-flex align-items-center">
                                <div class="avatar">${firstLetter}</div>
                                <div>
                                    <div class="contact-name">${displayName}</div>
                                    <div class="contact-role">${displayRole}</div>
                                </div>
                            </div>
                        </a>`;
        };

        const superAdmins = contacts.filter(c => c.role === 'SUPER_ADMIN');
        if (superAdmins.length > 0) {
          list.innerHTML += '<div class="list-group-item list-group-item-light text-muted small fw-bold text-uppercase">Super Admins</div>';
          recipientSelect.innerHTML += '<optgroup label="Super Admins">';
          superAdmins.forEach(sa => {
            const contactData = { branchId: null, role: 'SUPER_ADMIN', name: sa.branchName };
            list.innerHTML += createContactElement(contactData, sa.branchName, "Super Admin Group");
            recipientSelect.innerHTML += `<option value='${JSON.stringify(contactData)}'>${sa.branchName}</option>`;
          });
          recipientSelect.innerHTML += '</optgroup>';
        }

        const otherBranches = contacts.filter(c => c.role !== 'SUPER_ADMIN');
        if (otherBranches.length > 0) {
          list.innerHTML += '<div class="list-group-item list-group-item-light text-muted small fw-bold text-uppercase">Branches</div>';
          recipientSelect.innerHTML += '<optgroup label="Branches">';
          otherBranches.forEach(b => {
            const contactName = `${b.branchName}`;
            const roleName = b.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            const contactData = { branchId: b.branchId, role: b.role, name: contactName };
            list.innerHTML += createContactElement(contactData, contactName, roleName);
            recipientSelect.innerHTML += `<option value='${JSON.stringify(contactData)}'>${contactName} (${roleName})</option>`;
          });
          recipientSelect.innerHTML += '</optgroup>';
        }
      });
    });
  }

  function loadConversation(element) {
    const recipient = JSON.parse(element.dataset.contact);
    activeConversation = recipient;

    document.querySelectorAll('.contact-list a').forEach(a => a.classList.remove('active'));
    element.classList.add('active');
    document.getElementById('chat-header').textContent = `Chat with ${recipient.name}`;
    document.getElementById('message-input').disabled = false;

    const url = `http://localhost:8080/api/messages/conversation?otherBranchId=${recipient.branchId}&otherRole=${recipient.role}`;

    fetch(url, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(messages => {
      const chatBox = document.getElementById('chat-messages');
      chatBox.innerHTML = '';
      if (messages.length === 0) {
        chatBox.innerHTML = `<div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted"><p>No messages yet. Start the conversation!</p></div>`;
        return;
      }
      messages.forEach(msg => {
        const isSender = msg.senderBranchId === myProfile.branchId && msg.senderRole === myProfile.role;
        const messageClass = isSender ? 'sender' : 'receiver';
        const senderName = isSender ? 'Me' : msg.senderFullName;

        chatBox.innerHTML += `<div class="message ${messageClass}">
                                        <div class="sender-name">${senderName}</div>
                                        <div class="message-content">${msg.content}</div>
                                      </div>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  function sendMessage(receiverBranchId, content, recipientRole) {
    const data = { receiverBranchId, content, recipientRole };
    fetch('http://localhost:8080/api/messages/send', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data)
    }).then(res => {
      if(res.ok) {
        const activeLink = document.querySelector('.list-group-item.active');
        if (activeLink) {
          loadConversation(activeLink);
        }
      } else { alert('Failed to send message.'); }
    });
  }

  document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const contentInput = document.getElementById('message-input');
    const content = contentInput.value.trim();
    if (!content || !activeConversation.role) return;
    sendMessage(activeConversation.branchId, content, activeConversation.role);
    contentInput.value = '';
  });

  document.getElementById('compose-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const recipientSelect = document.getElementById('recipient-select');
    if (!recipientSelect.value) {
      alert('Please select a recipient.');
      return;
    }
    const recipientData = JSON.parse(recipientSelect.value);
    const content = document.getElementById('compose-message-text').value.trim();
    if (!recipientData || !content) return;
    sendMessage(recipientData.branchId, content, recipientData.role);
    composeModal.hide();
    this.reset();
  });

  document.addEventListener('DOMContentLoaded', loadContacts);
</script>
</body>
</html>






