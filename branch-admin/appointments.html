<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Appointments</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/print.css" media="print"> <!-- For printing the bill -->
    <script src="../js/auth.js" defer></script>
</head>
<body>
<div id="sidebar-placeholder"></div>

<div class="content">
    <h1>Appointment Report & Management</h1>
    <hr>
    <!-- Filter Card -->
    <div class="card bg-light mb-4 filter-card">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3"><label>Search Patient</label><input type="text" id="patientName" class="form-control"></div>
                <div class="col-md-3"><label>Filter by Date</label><input type="date" id="date" class="form-control"></div>
                <div class="col-md-3"><label>Filter by Status</label><select id="status" class="form-select"><option value="">All</option><option value="PENDING_PAYMENT">Pending</option><option value="CONFIRMED">Confirmed</option><option value="COMPLETED">Completed</option><option value="CANCELLED">Cancelled</option></select></div>
                <div class="col-md-3 d-flex align-items-end"><button id="filter-btn" class="btn btn-primary w-100">Filter / Search</button></div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <span id="result-summary"></span>
        <button id="print-btn" class="btn btn-secondary"><i class="bi bi-printer"></i> Print Report</button>
    </div>

    <!-- Appointments Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light"><tr><th>ID</th><th>Patient</th><th>Doctor</th><th>Date & Time</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="appointment-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    <nav class="mt-4"><ul id="pagination" class="pagination justify-content-center"></ul></nav>
</div>

<!-- Bill Modal -->
<div class="modal fade" id="billModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="bill-content" class="modal-body">
                <!-- Bill details will be loaded here by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printBill()">Print Bill</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/layout-loader.js"></script>
<script>
    const token = localStorage.getItem('authToken');
    let currentPage = 0;
    const billModal = new bootstrap.Modal(document.getElementById('billModal'));
    let currentBillHTML = ''; // store bill content for printing in new tab

    function loadAppointments(page = 0) {
        currentPage = page;
        const patientName = document.getElementById('patientName').value;
        const status = document.getElementById('status').value;
        const date = document.getElementById('date').value;

        let url = `http://localhost:8080/api/appointments?page=${page}&size=10&sort=appointmentDate,desc`;
        if (patientName) url += `&patientName=${patientName}`;
        if (status) url += `&status=${status}`;
        if (date) url += `&date=${date}`;

        fetch(url, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json())
            .then(pageData => {
                renderTable(pageData.content);
                renderPagination(pageData);
                document.getElementById('result-summary').textContent =
                    `Showing ${pageData.numberOfElements} of ${pageData.totalElements} results.`;
            });
    }

    function renderTable(appointments) {
        const tableBody = document.getElementById('appointment-table-body');
        tableBody.innerHTML = '';
        const statusList = ['PENDING_PAYMENT', 'CONFIRMED', 'COMPLETED', 'CANCELLED'];
        appointments.forEach(app => {
            const statusOptions = statusList.map(s =>
                `<option value="${s}" ${s === app.status ? 'selected' : ''}>${s}</option>`
            ).join('');
            tableBody.innerHTML += `
                <tr>
                    <td>#${app.id}</td>
                    <td>${app.patientName}</td>
                    <td>${app.doctorName}</td>
                    <td>${new Date(app.appointmentDate).toLocaleString()}</td>
                    <td>
                        <form class="d-flex status-update-form" data-id="${app.id}">
                            <select class="form-select form-select-sm" name="status">${statusOptions}</select>
                            <button type="submit" class="btn btn-success btn-sm ms-2" title="Update Status">
                                <i class="bi bi-check-lg"></i>
                            </button>
                        </form>
                    </td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewBill(${app.id})">View Bill</button>
                        <button class="btn btn-secondary btn-sm complete-btn" data-id="${app.id}">Mark as Completed</button>
                    </td>
                </tr>
            `;
        });
        attachRowEventListeners();
    }

    function attachRowEventListeners() {
        document.querySelectorAll('.status-update-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                updateStatus(this.dataset.id, this.querySelector('select').value);
            });
        });
        document.querySelectorAll('.complete-btn').forEach(button => {
            button.addEventListener('click', function() {
                updateStatus(this.dataset.id, 'COMPLETED');
            });
        });
    }

    function updateStatus(id, status) {
        fetch(`http://localhost:8080/api/appointments/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ status: status })
        }).then(response => {
            if (response.ok) {
                loadAppointments(currentPage);
            } else {
                alert('Failed to update status.');
            }
        });
    }

    function viewBill(appointmentId) {
        fetch(`http://localhost:8080/api/appointments/${appointmentId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(res => res.json())
            .then(app => {
                const appointmentDate = new Date(app.appointmentDate);
                const feeDisplay = app.fee ? Number(app.fee).toFixed(2) : '0.00';

                currentBillHTML = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <h4>Hospital Management System</h4>
                            <p class="mb-0">Appointment Summary & Bill</p>
                        </div>
                        <div>
                            <strong>Bill No:</strong> AP-${app.id}<br>
                            <strong>Date:</strong> ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                    <hr>
                    <p><strong>Patient:</strong> ${app.patientName}</p>
                    <p><strong>Doctor:</strong> ${app.doctorName}</p>
                    <p><strong>Appointment:</strong> ${appointmentDate.toLocaleString()}</p>
                    <p><strong>Reason:</strong> ${app.reason || 'N/A'}</p>
                    <hr>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tbody>
                            <tr>
                                <td>Appointment Fee</td>
                                <td style="text-align: right;">Rs. ${feeDisplay}</td>
                            </tr>
                            <tr style="font-weight: bold; border-top: 1px solid #ccc;">
                                <td>Total</td>
                                <td style="text-align: right;">Rs. ${feeDisplay}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p style="text-align: center; font-size: small; color: gray; margin-top: 20px;">
                        * This is a system generated bill.
                    </p>
                </div>
            `;

                document.getElementById('bill-content').innerHTML = currentBillHTML;
                billModal.show();
            });
    }

    function printBill() {
        const newWindow = window.open('', '_blank');
        newWindow.document.write(`
            <html>
                <head>
                    <title>Print Bill</title>
                </head>
                <body onload="window.print(); window.close();">
                    ${currentBillHTML}
                </body>
            </html>
        `);
        newWindow.document.close();
    }

    function renderPagination(pageData) {
        const paginationUl = document.getElementById('pagination');
        paginationUl.innerHTML = '';
        if (pageData.totalPages <= 1) return;
        if (!pageData.first) {
            paginationUl.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); loadAppointments(${currentPage - 1})">Previous</a></li>`;
        }
        if (!pageData.last) {
            paginationUl.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); loadAppointments(${currentPage + 1})">Next</a></li>`;
        }
    }

    document.getElementById('filter-btn').addEventListener('click', () => loadAppointments(0));
    document.getElementById('print-btn').addEventListener('click', () => window.print());
    document.addEventListener('DOMContentLoaded', () => loadAppointments(0));
</script>
</body>
</html>





<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>Manage Appointments</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <link rel="stylesheet" href="../css/styles.css">-->
<!--    <script src="../js/auth.js" defer></script>-->
<!--</head>-->
<!--<body>-->
<!--<div id="sidebar-placeholder"></div>-->
<!--<div class="content">-->
<!--    <div class="d-flex justify-content-between align-items-center">-->
<!--        <h1>Manage Appointments</h1>-->
<!--        <a href="book-appointment.html" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Book New Appointment</a>-->
<!--    </div>-->
<!--    <hr>-->
<!--    <table class="table table-hover">-->
<!--        <thead class="table-light">-->
<!--        <tr><th>ID</th><th>Patient Name</th><th>Doctor Name</th><th>Date & Time</th><th>Status</th></tr>-->
<!--        </thead>-->
<!--        <tbody id="appointment-table-body"></tbody>-->
<!--    </table>-->
<!--</div>-->
<!--<script src="../js/layout-loader.js"></script>-->
<!--<script>-->
<!--    const token = localStorage.getItem('authToken');-->
<!--    document.addEventListener('DOMContentLoaded', function() {-->
<!--        fetch('http://localhost:8080/api/appointments', { headers: { 'Authorization': 'Bearer ' + token } })-->
<!--            .then(res => res.json())-->
<!--            .then(appointments => {-->
<!--                const tbody = document.getElementById('appointment-table-body');-->
<!--                tbody.innerHTML = '';-->
<!--                appointments.forEach(app => {-->
<!--                    tbody.innerHTML += `-->
<!--                        <tr>-->
<!--                            <td>${app.id}</td>-->
<!--                            <td>${app.patientName}</td>-->
<!--                            <td>${app.doctorName}</td>-->
<!--                            <td>${new Date(app.appointmentDate).toLocaleString()}</td>-->
<!--                            <td><span class="badge bg-success">${app.status}</span></td>-->
<!--                        </tr>-->
<!--                    `;-->
<!--                });-->
<!--            });-->
<!--    });-->
<!--</script>-->
<!--</body>-->
<!--</html>-->














<!--<!DOCTYPE html>-->
<!--<html lang="en" xmlns:th="http://www.thymeleaf.org"-->
<!--      th:replace="~{branch-layout :: layout(~{::title}, ~{::.content-wrapper})}">-->
<!--<head>-->
<!--    <title th:text="'Appointments: ' + ${currentBranchName}">Branch Appointments</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->

<!--</head>-->
<!--<body>-->
<!--<div class="content-wrapper">-->
<!--    <div class="container-fluid">-->
<!--        <div class="d-flex justify-content-between align-items-center">-->
<!--            <h1 class="mt-4">Manage Appointments</h1>-->
<!--            <a th:href="@{/branch/appointments/new}" class="btn btn-lg btn-success mt-4">-->
<!--                <i class="bi bi-calendar-plus-fill"></i> Book New Appointment-->
<!--            </a>-->
<!--        </div>-->
<!--        <hr>-->

<!--        <div class="card bg-light mb-4 shadow-sm">-->
<!--            <div class="card-body">-->
<!--                <form class="row g-3 align-items-center">-->
<!--                    <div class="col-md-4">-->
<!--                        <label for="filterDate" class="form-label">Filter by Date</label>-->
<!--                        <input type="date" class="form-control" id="filterDate" name="date">-->
<!--                    </div>-->
<!--                    <div class="col-md-4">-->
<!--                        <label for="filterDoctor" class="form-label">Filter by Doctor</label>-->
<!--                        <select class="form-select" id="filterDoctor" name="doctorId">-->
<!--                            <option value="">All Doctors</option>-->
<!--                            <option th:each="doc : ${doctorListOfBranch}"-->
<!--                                    th:value="${doc.id}"-->
<!--                                    th:text="${doc.firstName} + ' ' + ${doc.lastName}">-->
<!--                            </option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div class="col-md-2">-->
<!--                        <label for="filterStatus" class="form-label">Filter by Status</label>-->
<!--                        <select class="form-select" id="filterStatus" name="status">-->
<!--                            <option value="">All Statuses</option>-->
<!--                            <option value="CONFIRMED">Confirmed</option>-->
<!--                            <option value="PENDING_PAYMENT">Pending Payment</option>-->
<!--                            <option value="CANCELLED">Cancelled</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div class="col-md-2 d-flex align-items-end">-->
<!--                        <button type="submit" class="btn btn-primary w-100">Filter</button>-->
<!--                    </div>-->
<!--                </form>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div class="card shadow-sm">-->
<!--            <div class="card-header">-->
<!--                <i class="bi bi-table"></i>-->
<!--                Appointment List-->
<!--            </div>-->
<!--            <div class="card-body">-->
<!--                <table class="table table-hover">-->
<!--                    <thead class="table-light">-->
<!--                    <tr>-->
<!--                        <th>ID</th>-->
<!--                        <th>Patient Name</th>-->
<!--                        <th>Doctor Name</th>-->
<!--                        <th>Date & Time</th>-->
<!--                        <th>Up Status</th>-->
<!--                        <th>Actions</th>-->
<!--                    </tr>-->
<!--                    </thead>-->
<!--                    <tbody>-->
<!--                    <tr th:each="app : ${appointmentList}">-->
<!--                        <td th:text="${app.id}">#1025</td>-->
<!--                        <td th:text="${app.patient.firstName} + ' ' + ${app.patient.lastName}">Kamal Perera</td>-->
<!--                        <td th:text="${app.doctor.firstName} + ' ' + ${app.doctor.lastName}">Dr. Silva</td>-->
<!--                        <td th:text="${#temporals.format(app.appointmentDate, 'yyyy-MM-dd HH:mm')}">2025-07-20 10:30</td>-->
<!--                        <td>-->
<!--&lt;!&ndash;                            <span class="badge"&ndash;&gt;-->
<!--&lt;!&ndash;                                  th:text="${app.status}"&ndash;&gt;-->
<!--&lt;!&ndash;                                  th:classappend="${&ndash;&gt;-->
<!--&lt;!&ndash;                                      app.status == 'CONFIRMED' ? 'bg-success' :&ndash;&gt;-->
<!--&lt;!&ndash;                                      (app.status == 'PENDING_PAYMENT' ? 'bg-warning text-dark' : 'bg-danger')&ndash;&gt;-->
<!--&lt;!&ndash;                                  }">&ndash;&gt;-->
<!--&lt;!&ndash;                                CONFIRMED&ndash;&gt;-->
<!--&lt;!&ndash;                            </span>&ndash;&gt;-->


<!--                            <select name="status" class="form-select form-select-sm">-->
<!--                                <option th:each="st : ${statusList}"-->
<!--                                        th:value="${st}"-->
<!--                                        th:text="${st}"-->
<!--                                        th:selected="${st == app.status}">-->
<!--                                </option>-->
<!--                            </select>-->
<!--                        </td>-->
<!--                        <td>-->
<!--                            <a href="#" class="btn btn-sm btn-info" title="View Details"><i class="bi bi-eye-fill"></i></a>-->
<!--                            <a href="#" class="btn btn-sm btn-danger" title="Cancel Appointment"><i class="bi bi-x-circle-fill"></i></a>-->
<!--                        </td>-->
<!--                    </tr>-->
<!--                    <tr>-->
<!--                        <td>#1026</td>-->
<!--                        <td>Nimali Fonseka</td>-->
<!--                        <td>Dr. Alwis</td>-->
<!--                        <td>2025-07-21 11:00</td>-->
<!--                        <td><span class="badge bg-warning text-dark">PENDING_PAYMENT</span></td>-->
<!--                        <td>-->
<!--                            <a href="#" class="btn btn-sm btn-info" title="View Details"><i class="bi bi-eye-fill"></i></a>-->
<!--                            <a href="#" class="btn btn-sm btn-danger" title="Cancel Appointment"><i class="bi bi-x-circle-fill"></i></a>-->
<!--                        </td>-->
<!--                    </tr>-->
<!--                    </tbody>-->
<!--                </table>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->
<!--</body>-->
<!--</html>-->