<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Internal Messaging - HMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="css/layout.css">
  <style>
  .chat-card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); overflow: hidden; }
  .chat-container { display: flex; height: calc(100vh - 180px); min-height: 600px; }
  .contact-list { width: 35%; border-right: 1px solid var(--border-color, #e9ecef); background-color: #f8f9fa; overflow-y: auto; }
  .contact-item {
    display: flex; align-items: center; gap: 1rem; padding: 1rem;
    cursor: pointer; transition: background-color 0.2s ease;
    text-decoration: none; color: var(--text-primary, #212529);
    border-bottom: 1px solid var(--border-color, #e9ecef);
  }
  .contact-item:hover { background-color: #e9ecef; }
  .contact-item.active { background-color: var(--primary-bg-light, rgba(13, 110, 253, 0.1)); font-weight: 600; }
  .contact-icon {
    width: 48px; height: 48px; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-size: 1.5rem;
    background-color: #e0e0e0; color: var(--text-secondary); flex-shrink: 0;
  }
  .contact-info { flex-grow: 1; }
  .contact-info p { margin: 0; font-weight: 500; }
  .contact-info small { color: var(--text-secondary, #6c757d); }
  .branch-header {
    padding: 0.5rem 1rem; background-color: #e9ecef; color: var(--text-secondary, #6c757d);
    font-weight: 600; font-size: 0.8rem; text-transform: uppercase;
  }
  .chat-window { width: 65%; display: flex; flex-direction: column; }
  .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color, #e9ecef); background-color: #ffffff; }
  .chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; background-color: #f1f3f5; }
  .message-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 18px; margin-bottom: 0.25rem; clear: both; }
  .message.sender { text-align: right; }
  .message.sender .message-bubble { background-color: var(--primary-color, #0d6efd); color: white; float: right; }
  .message.receiver .message-bubble { background-color: #ffffff; border: 1px solid #e0e0e0; float: left; }
  .message small {
    display: block; margin: 0 0.5rem 0.25rem; font-size: 0.75rem;
    color: var(--text-secondary, #6c757d); font-weight: 500;
  }
  .chat-input-area { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color, #e9ecef); background-color: #ffffff; }



  :root {
    --primary-color: #0d6efd;
    --sidebar-bg: #ffffff;
    --light-bg: #f8f9fa;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --border-color: #e9ecef;
    --primary-bg-light: rgba(13, 110, 253, 0.1);
  }

  body {
    display: flex;
    background-color: var(--light-bg);
    font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  .sidebar {
    height: 100vh;
    width: 260px;
    position: fixed;
    z-index: 1000;
    top: 0;
    left: 0;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
  }

  .sidebar .branch-name {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  #sidebar-profile-pic {
    border: 3px solid var(--border-color);
  }

  .sidebar .branch-name h4 {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1.25rem;
    margin-top: 0.75rem;
    margin-bottom: 0.25rem;
  }

  .sidebar .branch-name h5 {
    color: var(--primary-color);
    font-weight: 500;
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }

  .sidebar .branch-name p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 0;
  }

  .sidebar hr {
    border-color: var(--border-color);
    margin: 1rem 0;
  }

  /* --- Navigation Links --- */
  .sidebar a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    color: var(--text-secondary);
    font-weight: 500;
    text-decoration: none;
    transition: background-color 0.2s, color 0.2s;
  }

  .sidebar a:hover {
    background-color: var(--primary-bg-light);
    color: var(--primary-color);
  }

  .sidebar a.active {
    background-color: var(--primary-color);
    color: white;
    font-weight: 600;
  }

  .sidebar .dropdown a.nav-link {
    color: var(--text-secondary);
  }

  #logout-button {
    margin-top: auto;
  }

  .main-wrapper {
    margin-left: 260px;
    padding: 2rem;
    width: calc(100% - 260px);
  }
</style>
</head>
<body>

<div id="resp-sidebar-placeholder"></div>

<div class="main-wrapper">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Internal Messaging</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeModal"><i class="bi bi-pencil-square me-2"></i> New Message</button>
  </div>
  <hr class="mb-4">

  <div class="card chat-card">
    <div class="chat-container">
      <div id="contacts-list" class="contact-list"></div>
      <div class="chat-window">
        <div class="chat-header"><h5 id="chat-header" class="mb-0">Select a contact to start</h5></div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
          <form id="message-form" class="d-flex">
            <input type="text" id="message-input" class="form-control" placeholder="Type a message..." required disabled>
            <button type="submit" class="btn btn-primary ms-2"><i class="bi bi-send-fill"></i></button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="composeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="compose-form"><div class="modal-header"><h5 class="modal-title">Compose New Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label">To:</label><select id="recipient-select" class="form-select" required></select></div><div class="mb-3"><label class="form-label">Message:</label><textarea id="compose-message-text" class="form-control" rows="4" required></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Send Message</button></div></form></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/layout-loader.js"></script>

<script>
  const token = localStorage.getItem('authToken');
  let myProfile = {};
  let activeConversation = {};
  const composeModal = new bootstrap.Modal(document.getElementById('composeModal'));

  function loadContacts() {
    fetch('http://localhost:8080/api/staff/my-profile', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(profile => {
      myProfile = profile;
      fetch('http://localhost:8080/api/messages/contacts', { headers: { 'Authorization': 'Bearer ' + token } })
              .then(res => res.json()).then(contacts => {
        const list = document.getElementById('contacts-list');
        const recipientSelect = document.getElementById('recipient-select');
        list.innerHTML = '';
        recipientSelect.innerHTML = '<option value="">-- Select a Recipient --</option>';

        const superAdmins = contacts.filter(c => c.role === 'SUPER_ADMIN');
        if (superAdmins.length > 0) {
          list.innerHTML += '<div class="branch-header">Super Admins</div>';
          recipientSelect.innerHTML += '<optgroup label="Super Admins">';
          superAdmins.forEach(sa => {
            const contactName = sa.fullName || "Super Admin";
            const contactData = JSON.stringify({ userId: sa.userId, name: contactName });
            list.innerHTML += `<a href="#" class="contact-item" data-contact='${contactData}' onclick='loadSuperAdminConversation(this)'>
                                    <div class="contact-icon"><i class="bi bi-person-badge-fill"></i></div>
                                    <div class="contact-info"><p>${contactName}</p><small>System-wide</small></div>
                                </a>`;
            recipientSelect.innerHTML += `<option value='${contactData}'>${contactName}</option>`;
          });
          recipientSelect.innerHTML += '</optgroup>';
        }

        const otherBranches = contacts.filter(c => c.role !== 'SUPER_ADMIN');
        if (otherBranches.length > 0) {
          list.innerHTML += '<div class="branch-header">Other Branches</div>';
          recipientSelect.innerHTML += '<optgroup label="Branches">';
          otherBranches.forEach(b => {
            const contactName = `${b.branchName} (${b.role.replace('_', ' ')})`;
            const contactData = JSON.stringify({ branchId: b.branchId, role: b.role, name: contactName });
            list.innerHTML += `<a href="#" class="contact-item" data-contact='${contactData}' onclick='loadBranchConversation(this)'>
                                    <div class="contact-icon"><i class="bi bi-building"></i></div>
                                    <div class="contact-info"><p>${b.branchName}</p><small>${b.role.replace('_', ' ')}</small></div>
                                </a>`;
            recipientSelect.innerHTML += `<option value='${contactData}'>${contactName}</option>`;
          });
          recipientSelect.innerHTML += '</optgroup>';
        }
      });
    });
  }

  function loadBranchConversation(element) {
    const recipient = JSON.parse(element.dataset.contact);
    activeConversation = recipient;
    activeConversation.type = 'BRANCH';

    document.querySelectorAll('.contact-list a').forEach(a => a.classList.remove('active'));
    element.classList.add('active');
    document.getElementById('chat-header').textContent = `Chat with ${recipient.name}`;
    document.getElementById('message-input').disabled = false;

    const url = `http://localhost:8080/api/messages/conversation?otherBranchId=${recipient.branchId}&otherRole=${recipient.role}`;
    fetch(url, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(messages => renderMessages(messages));
  }

  function loadSuperAdminConversation(element) {
    const recipient = JSON.parse(element.dataset.contact);
    activeConversation = recipient;
    activeConversation.type = 'SUPER_ADMIN';

    document.querySelectorAll('.contact-list a').forEach(a => a.classList.remove('active'));
    element.classList.add('active');
    document.getElementById('chat-header').textContent = `Chat with ${recipient.name}`;
    document.getElementById('message-input').disabled = false;

    const url = `http://localhost:8080/api/messages/conversation-sa/${recipient.userId}`;
    fetch(url, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(messages => renderMessages(messages));
  }

  function renderMessages(messages) {
    const chatBox = document.getElementById('chat-messages');
    chatBox.innerHTML = '';
    messages.forEach(msg => {
      const senderClass = msg.senderId === myProfile.userId ? 'sender' : 'receiver';
      const senderName = senderClass === 'sender' ? 'Me' : msg.senderFullName.split(' ')[0];

      chatBox.innerHTML += `<div class="message ${senderClass} mb-3">
                <small>${senderName}</small>
                <div class="message-bubble">${msg.content}</div>
            </div>`;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function sendMessage(data) {
    fetch('http://localhost:8080/api/messages/send', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data)
    }).then(res => {
      if(res.ok) {
        const activeLink = document.querySelector('.contact-item.active');
        if (activeLink) {
          if(activeConversation.type === 'BRANCH') loadBranchConversation(activeLink);
          else if(activeConversation.type === 'SUPER_ADMIN') loadSuperAdminConversation(activeLink);
        }
      } else { alert('Failed to send message.'); }
    });
  }

  document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('message-input').value;
    if (!content || !activeConversation.type) return;

    let messageData = { content };
    if (activeConversation.type === 'BRANCH') {
      messageData.receiverBranchId = activeConversation.branchId;
      messageData.recipientRole = activeConversation.role;
    } else if (activeConversation.type === 'SUPER_ADMIN') {
      messageData.receiverId = activeConversation.userId;
    }
    sendMessage(messageData);
    this.reset();
  });

  document.getElementById('compose-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const recipientData = JSON.parse(document.getElementById('recipient-select').value);
    const content = document.getElementById('compose-message-text').value;
    if (!recipientData || !content) return;

    let messageData = { content };
    if (recipientData.branchId) {
      messageData.receiverBranchId = recipientData.branchId;
      messageData.recipientRole = recipientData.role;
    } else if (recipientData.userId) {
      messageData.receiverId = recipientData.userId;
    }
    sendMessage(messageData);
    composeModal.hide();
    this.reset();
  });

  document.addEventListener('DOMContentLoaded', loadContacts);
</script>
</body>
</html>





