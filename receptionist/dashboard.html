
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Branch Dashboard - HMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="css/layout.css">
  <style>
  .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
  .card-header { background-color: transparent; border-bottom: 1px solid var(--border-color, #e9ecef); font-weight: 600; }

  .stat-card { border-left-width: 4px; border-left-style: solid; }
  .border-left-primary { border-left-color: var(--primary-color, #0d6efd); }
  .border-left-info { border-left-color: #0dcaf0; }
  .border-left-secondary { border-left-color: #6c757d; }
  .border-left-success { border-left-color: #198754; }
  .border-left-danger { border-left-color: #dc3545; }

  .stat-card h5 { color: var(--text-secondary, #6c757d); font-size: 1rem; font-weight: 500; }
  .stat-card h2 { font-weight: 700; }
  .stat-card .icon { font-size: 2.5rem; opacity: 0.3; }

  .doctor-list-item { display: flex; align-items: center; gap: 1rem; }

  .doctor-avatar {
    width: 48px; height: 48px; border-radius: 50%;
    background-color: #e9ecef; color: var(--text-secondary);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; flex-shrink: 0;
  }

  .table { margin-bottom: 0; }
  .table thead th { border-bottom-width: 1px; background-color: #f8f9fa; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
  .table tbody td { vertical-align: middle; }

  :root {
    --primary-color: #0d6efd;
    --sidebar-bg: #ffffff;
    --light-bg: #f8f9fa;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --border-color: #e9ecef;
    --primary-bg-light: rgba(13, 110, 253, 0.1);
  }

  body {
    display: flex;
    background-color: var(--light-bg);
    font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  .sidebar {
    height: 100vh;
    width: 260px;
    position: fixed;
    z-index: 1000;
    top: 0;
    left: 0;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
  }

  .sidebar .branch-name {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  #sidebar-profile-pic {
    border: 3px solid var(--border-color);
  }

  .sidebar .branch-name h4 {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1.25rem;
    margin-top: 0.75rem;
    margin-bottom: 0.25rem;
  }

  .sidebar .branch-name h5 {
    color: var(--primary-color);
    font-weight: 500;
    font-size: 1rem;
    margin-bottom: 0.25rem;
  }

  .sidebar .branch-name p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 0;
  }

  .sidebar hr {
    border-color: var(--border-color);
    margin: 1rem 0;
  }

  /* --- Navigation Links --- */
  .sidebar a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    color: var(--text-secondary);
    font-weight: 500;
    text-decoration: none;
    transition: background-color 0.2s, color 0.2s;
  }

  .sidebar a:hover {
    background-color: var(--primary-bg-light);
    color: var(--primary-color);
  }

  .sidebar a.active {
    background-color: var(--primary-color);
    color: white;
    font-weight: 600;
  }

  .sidebar .dropdown a.nav-link {
    color: var(--text-secondary);
  }

  #logout-button {
    margin-top: auto;
  }

  .main-wrapper {
    margin-left: 260px;
    padding: 2rem;
    width: calc(100% - 260px);
  }
</style>
</head>
<body>

<div id="resp-sidebar-placeholder"></div>

<div class="main-wrapper">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="mb-0">Branch Dashboard</h1>
      <p id="current-date-time" class="text-muted"></p>
    </div>
  </div>
  <hr class="mb-4">

  <h2 id="todays-earnings" hidden></h2><h2 id="doctor-count" hidden></h2>
  <h2 id="receptionist-count" hidden></h2><h2 id="completed-count" hidden></h2>

  <h4 class="mb-3">Today's Summary</h4>
  <div class="row">
    <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card border-left-primary"><div class="card-body d-flex justify-content-between align-items-center"><div><h5>Online Bookings</h5><h2 id="online-count">...</h2></div><i class="bi bi-cloud-check-fill icon text-primary"></i></div></div></div>
    <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card border-left-secondary"><div class="card-body d-flex justify-content-between align-items-center"><div><h5>Walk-in / Manual</h5><h2 id="walkin-count">...</h2></div><i class="bi bi-person-walking icon text-secondary"></i></div></div></div>
    <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card border-left-success"><div class="card-body d-flex justify-content-between align-items-center"><div><h5>Confirmed Today</h5><h2 id="confirmed-count">...</h2></div><i class="bi bi-check2-circle icon text-success"></i></div></div></div>
    <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card border-left-danger"><div class="card-body d-flex justify-content-between align-items-center"><div><h5>Cancelled Today</h5><h2 id="cancelled-count">...</h2></div><i class="bi bi-x-circle icon text-danger"></i></div></div></div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-8 mb-4">
      <div class="card h-100">
        <div class="card-header">Doctors on Duty</div>
        <div id="doctors-on-duty-list" class="list-group list-group-flush"></div>
      </div>
    </div>
    <div class="col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-header">Appointment Status Breakdown</div>
        <div class="card-body d-flex align-items-center justify-content-center"><canvas id="appointmentStatusChart"></canvas></div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header"><i class="bi bi-cloud-check-fill me-2"></i> Today's Online Bookings</div>
    <div class="table-responsive">
      <table class="table table-hover"><thead class="table-light"><tr><th>ID</th><th>Patient</th><th>Doctor</th><th>Time</th><th>Status</th></tr></thead><tbody id="online-bookings-table"></tbody></table>
    </div>
  </div>
</div>

<script src="../js/layout-loader.js"></script>

<script>
  let myChart;
  function updateClock() { document.getElementById('current-date-time').textContent = new Date().toLocaleString('en-US', { dateStyle: 'full', timeStyle: 'medium' }); }
  updateClock(); setInterval(updateClock, 1000);

  function loadDashboardData(data) {
    document.getElementById('todays-earnings').textContent = `Rs. ${data.todaysEarnings.toFixed(2)}`;
    document.getElementById('doctor-count').textContent = data.doctorCount;
    document.getElementById('receptionist-count').textContent = data.receptionistCount;
    document.getElementById('online-count').textContent = data.onlineAppointments;
    document.getElementById('walkin-count').textContent = data.walkInAppointments;
    document.getElementById('completed-count').textContent = data.completedCount;
    document.getElementById('confirmed-count').textContent = data.confirmedCount;
    document.getElementById('cancelled-count').textContent = data.cancelledCount;
    renderAppointmentChart(data);
  }

  function loadDoctorsOnDuty() {
    const token = localStorage.getItem('authToken');
    fetch('http://localhost:8080/api/doctors/active-list', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.ok ? res.json() : Promise.reject('Failed to load doctors'))
            .then(doctors => {
              const list = document.getElementById('doctors-on-duty-list');
              list.innerHTML = '';
              if(doctors.length > 0) {
                doctors.forEach(doc => {
                  list.innerHTML += `
                        <div class="list-group-item doctor-list-item">
                            <div class="doctor-avatar">
                                <i class="bi bi-heart-pulse-fill"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">${doc.fullName}</h6>
                                <small class="text-muted">${doc.specialization}</small>
                            </div>
                        </div>`;
                });
              } else {
                list.innerHTML = '<div class="list-group-item">No active doctors found.</div>';
              }
            })
            .catch(error => {
              const list = document.getElementById('doctors-on-duty-list');
              list.innerHTML = '<div class="list-group-item text-danger">Could not load doctor list.</div>';
            });
  }

  function loadOnlineBookings() {
    const token = localStorage.getItem('authToken');
    fetch('http://localhost:8080/api/appointments/online-bookings/today', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json())
            .then(appointments => {
              const tbody = document.getElementById('online-bookings-table');
              tbody.innerHTML = '';
              if (appointments.length > 0) {
                appointments.forEach(app => {
                  const time = new Date(app.appointmentDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                  tbody.innerHTML += `<tr><td>#${app.id}</td><td>${app.patientName}</td><td>${app.doctorName}</td><td>${time}</td><td><span class="badge bg-primary bg-opacity-75">${app.status}</span></td></tr>`;
                });
              } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No online bookings for today.</td></tr>';
              }
            });
  }

  function renderAppointmentChart(data) {
    const ctx = document.getElementById('appointmentStatusChart');
    if (!ctx) return;
    if (myChart) myChart.destroy();
    myChart = new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Confirmed', 'Completed', 'Cancelled'],
        datasets: [{ data: [data.confirmedCount, data.completedCount, data.cancelledCount], backgroundColor: ['#0d6efd', '#198754', '#dc3545'] }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('authToken');
    fetch(`http://localhost:8080/api/branch-dashboard/summary`, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json())
            .then(summaryData => {
              loadDashboardData(summaryData);
            });
    loadDoctorsOnDuty();
    loadOnlineBookings();
  });
</script>
</body>
</html>






