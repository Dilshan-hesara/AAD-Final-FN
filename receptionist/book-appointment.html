<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book New Appointment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/auth.js" defer></script>
</head>
<body>
<div id="sidebar-placeholder"></div>

<div class="content">
    <h1>Book New Appointment</h1>
    <hr>
    <div class="card">
        <div class="card-body">
            <form id="book-appointment-form">
                <div class="mb-3">
                    <label class="form-label">Search & Select Patient</label>
                    <select id="patient-select" class="form-select" required></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Search & Select Doctor</label>
                    <select id="doctor-select" class="form-select" required></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Appointment Date & Time</label>
                    <input type="datetime-local" id="appointmentDate" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="appointmentFee" class="form-label">Appointment Fee (Rs.)</label>
                    <input type="text" id="appointmentFee" class="form-control" readonly>
                </div>
                <div class="mb-3">
                    <label for="reason" class="form-label">Reason for Visit (Optional)</label>
                    <textarea id="reason" class="form-control" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-success">Book Appointment</button>
            </form>
        </div>
    </div>
</div>

<!-- Bill Summary Modal -->
<div class="modal fade" id="billModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Appointment Summary & Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bill-content"></div>
            <div class="modal-footer">
                <button id="print-btn" type="button" class="btn btn-primary">Print / Save as PDF</button>
                <button id="download-pdf-btn" type="button" class="btn btn-secondary">Download PDF</button>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="../js/layout-loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
    $(document).ready(function() {
        const token = localStorage.getItem('authToken');
        let defaultFee = 0;

        // Initialize Select2 for Patients
        $('#patient-select').select2({
            placeholder: 'Type to search for a patient...',
            ajax: {
                url: 'http://localhost:8080/api/patients/search',
                dataType: 'json',
                delay: 250,
                headers: { 'Authorization': 'Bearer ' + token },
                data: params => ({ name: params.term, page: params.page || 0 }),
                processResults: data => ({
                    results: data.content.map(p => ({ id: p.id, text: p.fullName }))
                })
            }
        });

        // Initialize Select2 for Doctors
        $('#doctor-select').select2({
            placeholder: 'Type to search for a doctor...',
            ajax: {
                url: 'http://localhost:8080/api/doctors/search',
                dataType: 'json',
                delay: 250,
                headers: { 'Authorization': 'Bearer ' + token },
                data: params => ({ name: params.term, page: params.page || 0 }),
                processResults: data => ({
                    results: data.content.map(d => ({ id: d.id, text: `${d.fullName} (${d.specialization})` }))
                })
            }
        });

        // Fetch default fee
        $.ajax({
            url: 'http://localhost:8080/api/settings/appointment-fee',
            type: 'GET',
            headers: { 'Authorization': 'Bearer ' + token },
            success: data => {
                defaultFee = Number(data.fee || 0);
                $('#appointmentFee').val(defaultFee.toFixed(2));
            }
        });

        // Build bill HTML
        function buildBillHTML({patientText, doctorText, dateTime, fee, reason, billNo}) {
            return `
          <div id="print-area" style="font-family: Arial, sans-serif">
            <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
              <div>
                <h3 style="margin:0;">Hospital Management System</h3>
                <div style="font-size:12px;color:#666;">Appointment Summary & Bill</div>
              </div>
              <div style="text-align:right;">
                <div><strong>Bill No:</strong> ${billNo}</div>
                <div><strong>Date:</strong> ${new Date().toLocaleString()}</div>
              </div>
            </div>
            <hr>
            <div style="margin:12px 0;">
              <div><strong>Patient:</strong> ${patientText || '-'}</div>
              <div><strong>Doctor:</strong> ${doctorText || '-'}</div>
              <div><strong>Appointment:</strong> ${dateTime || '-'}</div>
              <div><strong>Reason:</strong> ${reason ? reason.replace(/\n/g,'<br>') : '-'}</div>
            </div>
            <hr>
            <div style="display:flex; justify-content:flex-end;">
              <table style="min-width:320px;">
                <tr>
                  <td style="padding:6px 8px;">Appointment Fee</td>
                  <td style="padding:6px 8px; text-align:right;">Rs. ${Number(fee||0).toFixed(2)}</td>
                </tr>
                <tr>
                  <td style="padding:6px 8px;"><strong>Total</strong></td>
                  <td style="padding:6px 8px; text-align:right;"><strong>Rs. ${Number(fee||0).toFixed(2)}</strong></td>
                </tr>
              </table>
            </div>
            <div style="margin-top:24px; font-size:12px; color:#666;">
              * This is a system generated bill for your appointment booking.
            </div>
          </div>
        `;
        }

        // Print handler
        function openPrintPreview(html) {
            const w = window.open('', '_blank');
            w.document.open();
            w.document.write(`
          <html>
            <head>
              <title>Appointment Bill</title>
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <style>@media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }</style>
            </head>
            <body>${html}
              <script>window.onload = function(){ window.print(); };<\/script>
            </body>
          </html>
        `);
            w.document.close();
        }

        // Download PDF handler
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const billNode = document.querySelector('#bill-content #print-area');
            if (!billNode) return;

            const canvas = await html2canvas(billNode, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');

            const pdf = new jsPDF('p', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const imgWidth = pageWidth - 40;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
            pdf.save('appointment-bill.pdf');
        }

        // Form submit
        $('#book-appointment-form').on('submit', function(e) {
            e.preventDefault();

            const patientId = $('#patient-select').val();
            const doctorId  = $('#doctor-select').val();
            const patientText = $('#patient-select').find(':selected').text();
            const doctorText  = $('#doctor-select').find(':selected').text();

            const appointmentData = {
                patientId,
                doctorId,
                appointmentDate: $('#appointmentDate').val(),
                reason: $('#reason').val()
            };

            $.ajax({
                url: 'http://localhost:8080/api/appointments/by-staff',
                type: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                data: JSON.stringify(appointmentData),
                success: function() {
                    const billNo = 'AP-' + Date.now().toString().slice(-8);
                    const fee = Number($('#appointmentFee').val() || defaultFee || 0);

                    const html = buildBillHTML({
                        patientText,
                        doctorText,
                        dateTime: $('#appointmentDate').val(),
                        fee,
                        reason: $('#reason').val(),
                        billNo
                    });

                    $('#bill-content').html(html);
                    const modal = new bootstrap.Modal(document.getElementById('billModal'));
                    modal.show();

                    $('#print-btn').off('click').on('click', () => openPrintPreview(html));
                    $('#download-pdf-btn').off('click').on('click', () => downloadPDF());

                    $('#billModal').off('hidden.bs.modal').on('hidden.bs.modal', () => {
                        window.location.href = 'appointments.html';
                    });
                },
                error: function() {
                    alert('Error booking appointment.');
                }
            });
        });
    });
</script>
</body>
</html>
