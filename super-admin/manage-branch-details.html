<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Branch Details - HMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .table { margin-bottom: 0; }
    .table thead th { border-bottom-width: 1px; background-color: #f8f9fa; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
    .table tbody td { vertical-align: middle; }
    .status-badge { font-weight: 600; padding: 0.4em 0.9em; border-radius: 50px; font-size: 0.75rem; }
    .status-active { background-color: rgba(25, 135, 84, 0.1); color: #198754; }
    .status-inactive { background-color: rgba(108, 117, 125, 0.1); color: #6c757d; }
    .action-dropdown .dropdown-toggle::after { display: none; }
    .breadcrumb { background-color: #e9ecef; padding: 0.75rem 1rem; border-radius: 8px; }
    .breadcrumb-item a { text-decoration: none; }




    :root {
        --primary-color: #0d6efd;
        --sidebar-bg: #ffffff;
        --light-bg: #f8f9fa;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --border-color: #e9ecef;
        --primary-bg-light: rgba(13, 110, 253, 0.1);
    }

    body {
        display: flex;
        background-color: var(--light-bg);
        font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 260px;
        height: 100vh;
        background-color: var(--sidebar-bg);
        border-right: 1px solid var(--border-color);
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
        z-index: 1000;
        transition: left 0.3s ease;
    }

    .sidebar-profile {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 0 0.5rem;
    }

    .sidebar-profile img {
        border: 3px solid var(--border-color);
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 50%;
    }

    .sidebar-profile h5 {
        color: var(--primary-color);
        margin-top: 0.75rem;
        margin-bottom: 0.25rem;
        font-weight: 700;
        font-size: 1.25rem;
    }

    .sidebar-profile p {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .sidebar-nav {
        list-style: none;
        padding: 0;
        margin: 0;
        flex-grow: 1;
    }

    .sidebar-nav .nav-item a {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        padding: 0.8rem 1rem;
        border-radius: 8px;
        color: var(--text-secondary);
        font-weight: 500;
        text-decoration: none;
        transition: background-color 0.2s, color 0.2s;
        font-size: 0.95rem;
    }

    .sidebar-nav .nav-item a i {
        font-size: 1.1rem;
    }

    .sidebar-nav .nav-item a:hover {
        background-color: var(--primary-bg-light);
        color: var(--primary-color);
    }

    .sidebar-nav .nav-item a.active {
        background-color: var(--primary-color);
        color: white;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
    }

    .main-wrapper {
        flex-grow: 1;
        padding: 2rem;
        margin-left: 260px;
    }


    .mobile-header {
        display: none;
    }
    .overlay {
        display: none;
    }

    @media (max-width: 992px) {
        .sidebar {
            left: -280px;
        }
        .sidebar.active {
            left: 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        .main-wrapper {
            margin-left: 0;
        }
        .mobile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 999;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .menu-toggle {
            font-size: 1.5rem;
            background: none;
            border: none;
        }
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 998;
            display: block;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .main-wrapper .content-inner {
            padding: 1.5rem;
        }
    }

</style>
</head>
<body>

<div id="sidebar-placeholder"></div>

<div class="main-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Manage Branch Details</h1>
        <a href="add-new-branch.html" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i> Add New Branch</a>
    </div>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="dashboard.html">Home</a></li>
            <li class="breadcrumb-item"><a href="manage-all-branches.html">Manage Branches</a></li>
            <li class="breadcrumb-item active" aria-current="page">Branch Details</li>
        </ol>
    </nav>
    <hr class="mb-4">

    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                <tr><th>#</th><th>Name</th><th>Location</th><th>Status</th><th class="text-end">Actions</th></tr>
                </thead>
                <tbody id="branch-details-table"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editBranchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Edit Branch</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="edit-branch-form">
                    <input type="hidden" id="editBranchId">
                    <div class="mb-3"><label class="form-label">Branch Name</label><input type="text" id="editBranchName" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Location</label><input type="text" id="editBranchLocation" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Contact Number</label><input type="tel" id="editBranchContact" class="form-control" required></div>
                    <div class="mb-3"><label class="form-label">Email Address</label><input type="email" id="editBranchEmail" class="form-control" required></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="edit-branch-form" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/layout-loader.js"></script>

<script>
    const token = localStorage.getItem('authToken');
    const editModal = new bootstrap.Modal(document.getElementById('editBranchModal'));

    function loadBranches() {
        fetch('http://localhost:8080/api/super/branch', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(branches => {
            const tbody = document.getElementById('branch-details-table');
            tbody.innerHTML = '';
            if(branches.length === 0){
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted p-4">No branches found.</td></tr>`;
                return;
            }
            branches.forEach((b, index) => {
                const isActive = b.status === 'ACTIVE';
                const statusClass = isActive ? 'status-active' : 'status-inactive';
                const statusText = isActive ? 'ACTIVE' : 'INACTIVE';
                const actionText = isActive ? 'Deactivate' : 'Activate';
                const newStatus = isActive ? 'INACTIVE' : 'ACTIVE';
                const branchDataString = JSON.stringify(b).replace(/'/g, "&apos;");

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${index + 1}</strong></td>
                        <td>${b.name}</td>
                        <td>${b.location}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="text-end">
                            <div class="dropdown action-dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item edit-btn" href="#" data-branch='${branchDataString}'><i class="bi bi-pencil-fill me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="updateStatus(${b.id}, '${newStatus}')">${actionText}</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteBranch(${b.id})"><i class="bi bi-trash-fill me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>`;
            });
            attachEditListeners();
        });
    }

    function attachEditListeners() {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const branch = JSON.parse(this.dataset.branch.replace(/&apos;/g, "'"));
                document.getElementById('editBranchId').value = branch.id;
                document.getElementById('editBranchName').value = branch.name;
                document.getElementById('editBranchLocation').value = branch.location;
                document.getElementById('editBranchContact').value = branch.contactNumber;
                document.getElementById('editBranchEmail').value = branch.email;
                editModal.show();
            });
        });
    }

    document.getElementById('edit-branch-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const branchId = document.getElementById('editBranchId').value;
        const data = {
            name: document.getElementById('editBranchName').value,
            location: document.getElementById('editBranchLocation').value,
            contactNumber: document.getElementById('editBranchContact').value,
            email: document.getElementById('editBranchEmail').value
        };
        fetch(`http://localhost:8080/api/super/branch/${branchId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(data)
        }).then(res => { if(res.ok) { editModal.hide(); loadBranches(); } else { alert('Error updating'); }});
    });

    function deleteBranch(id) {
        if (!confirm('Are you sure? This action will permanently delete the branch and cannot be undone.')) return;
        fetch(`http://localhost:8080/api/super/branch/${id}`, {
            method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
        }).then(res => { if(res.ok) loadBranches(); else alert('Error deleting branch.'); });
    }

    function updateStatus(id, status) {
        if (!confirm(`Are you sure you want to set the status to ${status}?`)) return;
        fetch(`http://localhost:8080/api/super/branch/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ status: status })
        }).then(res => { if(res.ok) loadBranches(); else alert('Error updating status.'); });
    }

    document.addEventListener('DOMContentLoaded', loadBranches);
</script>
</body>
</html>











