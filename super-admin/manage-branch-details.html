<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Branch Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/auth.js" defer></script>
</head>
<body>
<div id="sidebar-placeholder"></div>
<div class="content">
    <div class="d-flex justify-content-between align-items-center">
        <h3>Manage Branch Details</h3>
        <a href="add-new-branch.html" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add New Branch</a>
    </div>
    <hr>
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                    <tr><th>#</th><th>Name</th><th>Location</th><th>Status</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="branch-details-table"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editBranchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Branch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-branch-form">
                    <input type="hidden" id="editBranchId">
                    <div class="mb-3"><label>Branch Name</label><input type="text" id="editBranchName" class="form-control" required></div>
                    <div class="mb-3"><label>Location</label><input type="text" id="editBranchLocation" class="form-control" required></div>
                    <div class="mb-3"><label>Contact</label><input type="tel" id="editBranchContact" class="form-control" required></div>
                    <div class="mb-3"><label>Email</label><input type="email" id="editBranchEmail" class="form-control" required></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" form="edit-branch-form" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/layout-loader.js"></script>
<script>
    const token = localStorage.getItem('authToken');
    const editModal = new bootstrap.Modal(document.getElementById('editBranchModal'));



    function loadBranches() {
        fetch('http://localhost:8080/api/super/branch', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(branches => {
            const tbody = document.getElementById('branch-details-table');
            tbody.innerHTML = '';
            branches.forEach((b, index) => {
                // =============================================================
                // CRITICAL FIX STARTS HERE
                // =============================================================
                const isActive = b.status === 'ACTIVE';
                const statusBadge = `<span class="badge bg-${isActive ? 'success' : 'secondary'}">${b.status || 'N/A'}</span>`;
                const statusButton = isActive
                    ? `<button class="btn btn-sm btn-warning" onclick="updateStatus(${b.id}, 'INACTIVE')">Deactivate</button>`
                    : `<button class="btn btn-sm btn-success" onclick="updateStatus(${b.id}, 'ACTIVE')">Activate</button>`;
                // =============================================================
                // CRITICAL FIX ENDS HERE
                // =============================================================

                tbody.innerHTML += `
                    <tr>
                        <th>${index + 1}</th>
                        <td>${b.name}</td>
                        <td>${b.location}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-btn" data-branch='${JSON.stringify(b)}'><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBranch(${b.id})"><i class="bi bi-trash-fill"></i></button>
                            ${statusButton}
                        </td>
                    </tr>`;
            });
            attachEditListeners();
        });
    }

    // ... all your other functions (attachEditListeners, deleteBranch, updateStatus, etc.)

    document.addEventListener('DOMContentLoaded', loadBranches);

    function attachEditListeners() {
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const branch = JSON.parse(this.dataset.branch);
                document.getElementById('editBranchId').value = branch.id;
                document.getElementById('editBranchName').value = branch.name;
                document.getElementById('editBranchLocation').value = branch.location;
                document.getElementById('editBranchContact').value = branch.contactNumber;
                document.getElementById('editBranchEmail').value = branch.email;
                editModal.show();
            });
        });
    }

    document.getElementById('edit-branch-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const branchId = document.getElementById('editBranchId').value;
        const data = {
            name: document.getElementById('editBranchName').value,
            location: document.getElementById('editBranchLocation').value,
            contactNumber: document.getElementById('editBranchContact').value,
            email: document.getElementById('editBranchEmail').value
        };
        fetch(`http://localhost:8080/api/super/branch/${branchId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify(data)
        }).then(res => { if(res.ok) { editModal.hide(); loadBranches(); } else { alert('Error updating'); }});
    });

    function deleteBranch(id) {
        if (!confirm('Are you sure? This action cannot be undone.')) return;
        fetch(`http://localhost:8080/api/super/branch/${id}`, {
            method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token }
        }).then(res => { if(res.ok) loadBranches(); else alert('Error deleting branch.'); });
    }

    function updateStatus(id, status) {
        fetch(`http://localhost:8080/api/super/branch/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ status: status })
        }).then(res => { if(res.ok) loadBranches(); else alert('Error updating status.'); });
    }

    document.addEventListener('DOMContentLoaded', loadBranches);
</script>
</body>
</html>