<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Super Admin Messaging - HMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

 <style>
  .chat-card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); overflow: hidden; }
  .chat-container { display: flex; height: calc(100vh - 180px); min-height: 600px; }
  .contact-list { width: 35%; border-right: 1px solid var(--border-color, #e9ecef); background-color: #f8f9fa; overflow-y: auto; }
  .contact-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; cursor: pointer; transition: background-color 0.2s ease; text-decoration: none; color: var(--text-primary, #212529); border-bottom: 1px solid var(--border-color, #e9ecef); }
  .contact-item:hover { background-color: #e9ecef; }
  .contact-item.active { background-color: var(--primary-bg-light, rgba(13, 110, 253, 0.1)); font-weight: 600; }

  .contact-avatar {
    width: 48px; height: 48px; border-radius: 50%;
    background-color: #e0e0e0; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; color: var(--text-secondary, #6c757d);
  }

  .contact-info { flex-grow: 1; }
  .contact-info p { margin: 0; font-weight: 500; }
  .contact-info small { color: var(--text-secondary, #6c757d); }
  .branch-header { padding: 0.5rem 1rem; background-color: #e9ecef; color: var(--text-secondary, #6c757d); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
  .chat-window { width: 65%; display: flex; flex-direction: column; }
  .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color, #e9ecef); background-color: #ffffff; }
  .chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; background-color: #f1f3f5; }
  .message-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 18px; margin-bottom: 0.25rem; clear: both; }
  .message.sender { text-align: right; }
  .message.sender .message-bubble { background-color: var(--primary-color, #0d6efd); color: white; float: right; }
  .message.receiver .message-bubble { background-color: #ffffff; border: 1px solid #e0e0e0; float: left; }
  .message small { display: block; margin: 0 0.5rem 0.25rem; font-size: 0.75rem; color: var(--text-secondary, #6c757d); }
  .chat-input-area { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color, #e9ecef); background-color: #ffffff; }


  :root {
    --primary-color: #0d6efd;
    --sidebar-bg: #ffffff;
    --light-bg: #f8f9fa;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --border-color: #e9ecef;
    --primary-bg-light: rgba(13, 110, 253, 0.1);
  }
  body {
    display: flex;
    background-color: var(--light-bg);
    font-family: 'Inter', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 260px;
    height: 100vh;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    padding: 1.5rem 1rem;
    display: flex;
    flex-direction: column;
    z-index: 1000;
    transition: left 0.3s ease;
  }

  .sidebar-profile {
    text-align: center;
    margin-bottom: 1.5rem;
    padding: 0 0.5rem;
  }

  .sidebar-profile img {
    border: 3px solid var(--border-color);
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
  }

  .sidebar-profile h5 {
    color: var(--primary-color);
    margin-top: 0.75rem;
    margin-bottom: 0.25rem;
    font-weight: 700;
    font-size: 1.25rem;
  }

  .sidebar-profile p {
    color: var(--text-secondary);
    font-size: 0.9rem;
  }

  .sidebar-nav {
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
  }

  .sidebar-nav .nav-item a {
    display: flex;
    align-items: center;
    gap: 0.85rem;
    padding: 0.8rem 1rem;
    border-radius: 8px;
    color: var(--text-secondary);
    font-weight: 500;
    text-decoration: none;
    transition: background-color 0.2s, color 0.2s;
    font-size: 0.95rem;
  }

  .sidebar-nav .nav-item a i {
    font-size: 1.1rem;
  }

  .sidebar-nav .nav-item a:hover {
    background-color: var(--primary-bg-light);
    color: var(--primary-color);
  }

  .sidebar-nav .nav-item a.active {
    background-color: var(--primary-color);
    color: white;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
  }

  .main-wrapper {
    flex-grow: 1;
    padding: 2rem;
    margin-left: 260px;
  }

  .mobile-header {
    display: none;
  }
  .overlay {
    display: none;
  }

  @media (max-width: 992px) {
    .sidebar {
      left: -280px;
    }
    .sidebar.active {
      left: 0;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }
    .main-wrapper {
      margin-left: 0;
    }
    .mobile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 999;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .menu-toggle {
      font-size: 1.5rem;
      background: none;
      border: none;
    }
    .overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 998;
      display: block;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .main-wrapper .content-inner {
      padding: 1.5rem;
    }
  }
</style>
</head>
<body>

<div id="sidebar-placeholder"></div>

<div class="main-wrapper">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Super Admin Messaging</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeModal"><i class="bi bi-pencil-square me-2"></i> New Message</button>
  </div>
  <hr class="mb-4">
  <div class="card chat-card">
    <div class="chat-container">
      <div id="contacts-list" class="contact-list"></div>
      <div class="chat-window">
        <div class="chat-header"><h5 id="chat-header" class="mb-0">Select a contact to start</h5></div>
        <div id="chat-messages" class="chat-messages"></div>
        <div class="chat-input-area">
          <form id="message-form" class="d-flex">
            <input type="text" id="message-input" class="form-control" placeholder="Type a message..." required disabled>
            <button type="submit" class="btn btn-primary ms-2"><i class="bi bi-send-fill"></i></button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="composeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><form id="compose-form"><div class="modal-header"><h5 class="modal-title">Compose New Message</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="mb-3"><label class="form-label">To:</label><select id="recipient-select" class="form-select" required></select></div><div class="mb-3"><label class="form-label">Message:</label><textarea id="compose-message-text" class="form-control" rows="4" required></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Send Message</button></div></form></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/layout-loader.js"></script>

<script>
  const token = localStorage.getItem('authToken');
  let myProfile = {};
  let activeConversation = {};
  const composeModal = new bootstrap.Modal(document.getElementById('composeModal'));

  function getIconForRole(role) {
    switch(role) {
      case 'BRANCH_ADMIN':
        return 'bi-person-video3';
      case 'RECEPTIONIST':
        return 'bi-person-workspace';
      default:
        return 'bi-person-fill';
    }
  }

  function loadContacts() {
    fetch('http://localhost:8080/api/staff/my-profile', { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(profile => {
      myProfile = profile;
      fetch('http://localhost:8080/api/super-admin/messages/contacts', { headers: { 'Authorization': 'Bearer ' + token } })
              .then(res => res.json()).then(contacts => {
        const contactsList = document.getElementById('contacts-list');
        const recipientSelect = document.getElementById('recipient-select');
        contactsList.innerHTML = '';
        recipientSelect.innerHTML = '<option value="">-- Select a Recipient --</option>';

        const groupedByBranch = contacts
                .filter(contact => contact.branchName)
                .reduce((acc, contact) => {
                  const branch = contact.branchName;
                  if (!acc[branch]) acc[branch] = [];
                  acc[branch].push(contact);
                  return acc;
                }, {});

        for (const branchName in groupedByBranch) {
          contactsList.innerHTML += `<div class="branch-header">${branchName}</div>`;
          recipientSelect.innerHTML += `<optgroup label="${branchName}">`;
          groupedByBranch[branchName].forEach(contact => {
            const contactData = JSON.stringify(contact).replace(/'/g, "&apos;");
            const displayName = `${contact.fullName}`;
            const displayRole = contact.role.replace('_', ' ');
            const iconClass = getIconForRole(contact.role);

            contactsList.innerHTML += `
                                <a href="#" class="contact-item" data-contact='${contactData}' onclick='loadConversation(this)'>
                                    <div class="contact-avatar">
                                        <i class="bi ${iconClass}"></i>
                                    </div>
                                    <div class="contact-info">
                                        <p>${displayName}</p>
                                        <small>${displayRole}</small>
                                    </div>
                                </a>`;
            recipientSelect.innerHTML += `<option value='${contactData}'>${contact.fullName} (${displayRole})</option>`;
          });
          recipientSelect.innerHTML += `</optgroup>`;
        }
      });
    });
  }


  function loadConversation(element) {
    const recipient = JSON.parse(element.dataset.contact.replace(/&apos;/g, "'"));
    activeConversation = recipient;
    document.querySelectorAll('.contact-list a').forEach(a => a.classList.remove('active'));
    element.classList.add('active');
    document.getElementById('chat-header').textContent = `Chat with ${recipient.fullName}`;
    document.getElementById('message-input').disabled = false;
    fetch(`http://localhost:8080/api/super-admin/messages/conversation/${recipient.userId}`, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json()).then(messages => {
      const chatBox = document.getElementById('chat-messages');
      chatBox.innerHTML = '';
      messages.forEach(msg => {
        const senderClass = msg.senderId === myProfile.userId ? 'sender' : 'receiver';
        const senderName = senderClass === 'sender' ? 'Me' : msg.senderFullName.split(' ')[0];
        chatBox.innerHTML += `<div class="message ${senderClass} mb-3"><small>${senderName}</small><div class="message-bubble">${msg.content}</div></div>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  function sendMessage(receiverId, content) {
    if (!content || !receiverId) return;
    const data = { receiverId, content };
    fetch('http://localhost:8080/api/super-admin/messages/send', {
      method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }, body: JSON.stringify(data)
    }).then(res => {
      if(res.ok) {
        const activeLink = document.querySelector('.contact-item.active');
        if (activeLink) loadConversation(activeLink);
      } else { alert('Failed to send message.'); }
    });
  }

  document.getElementById('message-form').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage(activeConversation.userId, document.getElementById('message-input').value);
    this.reset();
  });

  document.getElementById('compose-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const recipientData = JSON.parse(document.getElementById('recipient-select').value.replace(/&apos;/g, "'"));
    const content = document.getElementById('compose-message-text').value;
    sendMessage(recipientData.userId, content);
    composeModal.hide();
    this.reset();
    setTimeout(loadContacts, 500);
  });

  document.addEventListener('DOMContentLoaded', loadContacts);
</script>
</body>
</html>



