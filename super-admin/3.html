<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Dashboard</title>
</head>
<body>
<div id="sidebar-placeholder"></div>
<div class="content">
  <h1 class="mb-0">Advanced Analytics Dashboard</h1>
  <hr>
  <div class="card mb-4"><div class="card-body d-flex justify-content-end gap-2">
    <input type="date" id="startDate" class="form-control w-auto">
    <input type="date" id="endDate" class="form-control w-auto">
    <button id="filter-btn" class="btn btn-primary">Apply Filter</button>
  </div></div>

  <div class="row">
    <div class="col-lg-3"><div class="card card-body mb-4"><h5>Revenue</h5><h3 id="revenue-stat">...</h3></div></div>
    <div class="col-lg-3"><div class="card card-body mb-4"><h5>New Patients</h5><h3 id="new-patients-stat">...</h3></div></div>
    <div class="col-lg-3"><div class="card card-body mb-4"><h5>Confirmed Appts</h5><h3 id="confirmed-stat">...</h3></div></div>
    <div class="col-lg-3"><div class="card card-body mb-4"><h5>Completed Appts</h5><h3 id="completed-stat">...</h3></div></div>
  </div>

  <div class="row">
    <div class="col-lg-8"><div class="card"><div class="card-body"><canvas id="trendChart"></canvas></div></div></div>
    <div class="col-lg-4"><div class="card"><div class="card-body"><canvas id="typeChart"></canvas></div></div></div>
  </div>

  <div class="row mt-4">
    <div class="col-lg-6"><div class="card"><div class="card-header">Top Performing Doctors</div><table class="table mb-0"><thead><tr><th>Doctor</th><th>Appointments</th></tr></thead><tbody id="top-doctors-table"></tbody></table></div></div>
    <div class="col-lg-6"><div class="card"><div class="card-header">Recent Activity</div><ul id="recent-activity-list" class="list-group list-group-flush"></ul></div></div>
  </div>
</div>

<script src="js/layout-loader.js"></script>
<script>
  const token = localStorage.getItem('authToken');
  let trendChartInstance, typeChartInstance; // To hold chart instances

  // --- Main function to load all dashboard data ---
  function loadDashboardData() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');

    // Default to the last 7 days if no dates are selected
    const endDate = endDateInput.value ? new Date(endDateInput.value) : new Date();
    const startDate = startDateInput.value ? new Date(startDateInput.value) : new Date(new Date().setDate(endDate.getDate() - 6));

    // Format dates to ISO string (e.g., "2025-08-16T00:00:00")
    const isoStartDate = startDate.toISOString().split('T')[0] + 'T00:00:00';
    const isoEndDate = endDate.toISOString().split('T')[0] + 'T23:59:59';

    // In a real app, you would get the branchId from the profile API call
    const branchId = 1; // Placeholder

    const url = `http://localhost:8080/api/branch-dashboard/${branchId}?startDate=${isoStartDate}&endDate=${isoEndDate}`;

    fetch(url, { headers: { 'Authorization': 'Bearer ' + token } })
            .then(res => res.json())
            .then(data => {
              // Populate all the statistic cards
              document.getElementById('revenue-stat').textContent = `Rs. ${data.revenue.toFixed(2)}`;
              document.getElementById('new-patients-stat').textContent = data.newPatientCount;
              document.getElementById('confirmed-stat').textContent = data.confirmedAppointments;
              document.getElementById('completed-stat').textContent = data.completedAppointments;

              // Render all visual components
              renderTrendChart(data.appointmentTrend);
              renderTypeChart(data);
              renderTopDoctors(data.topDoctors);
              // You would add a function here to render recent activities
            })
            .catch(error => console.error("Error loading dashboard data:", error));
  }

  // --- Functions to render charts and tables ---
  function renderTrendChart(trendData) {
    const ctx = document.getElementById('trendChart').getContext('2d');
    if (trendChartInstance) trendChartInstance.destroy();
    trendChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: trendData.map(d => d.date),
        datasets: [{
          label: 'Appointments per Day',
          data: trendData.map(d => d.count),
          borderColor: '#0d6efd',
          tension: 0.1
        }]
      }
    });
  }

  function renderTypeChart(dashboardData) {
    const ctx = document.getElementById('typeChart').getContext('2d');
    if (typeChartInstance) typeChartInstance.destroy();
    typeChartInstance = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Online Bookings', 'Walk-ins'],
        datasets: [{
          data: [dashboardData.onlineBookings, dashboardData.walkInBookings],
          backgroundColor: ['#198754', '#6c757d']
        }]
      }
    });
  }

  function renderTopDoctors(topDoctors) {
    const tableBody = document.getElementById('top-doctors-table');
    tableBody.innerHTML = '';
    if (topDoctors.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="2">No data for this period.</td></tr>';
    } else {
      topDoctors.forEach(doc => {
        tableBody.innerHTML += `<tr><td>${doc.doctorName}</td><td>${doc.appointmentCount}</td></tr>`;
      });
    }
  }

  // --- Event Listeners ---
  document.getElementById('filter-btn').addEventListener('click', loadDashboardData);
  document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>

</body>
</html>




